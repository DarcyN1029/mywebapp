<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cattle Manager Pro</title>
  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
</head>
<body style="margin:0;font-family:system-ui,sans-serif;background:#f5f1e8">
  <div id="root"></div>
  <script type="text/babel">
const {useState, useEffect} = React;

const useLocalStorage = (key, init) => {
  const [val, setVal] = useState(() => {
    try {
      const item = localStorage.getItem(key);
      return item ? JSON.parse(item) : init;
    } catch {
      return init;
    }
  });
  useEffect(() => {
    try {
      localStorage.setItem(key, JSON.stringify(val));
    } catch(e) {
      console.error('Save error:', e);
    }
  }, [key, val]);
  return [val, setVal];
};

const calculateAge = (birthDate) => {
  if(!birthDate) return '‚Äî';
  const today = new Date();
  const birth = new Date(birthDate);
  const ageInDays = Math.floor((today - birth) / (1000 * 60 * 60 * 24));
  if(ageInDays < 0) return '‚Äî';
  if(ageInDays < 30) return `${ageInDays}d`;
  if(ageInDays < 365) return `${Math.floor(ageInDays / 30)}mo`;
  const years = Math.floor(ageInDays / 365);
  const remainingMonths = Math.floor((ageInDays % 365) / 30);
  return remainingMonths > 0 ? `${years}y ${remainingMonths}mo` : `${years}y`;
};

const App = () => {
  const [tab, setTab] = useState('dashboard');
  const [cattle, setCattle] = useLocalStorage('cattle_v6', []);
  const [pens, setPens] = useLocalStorage('pens_v2', []);
  const [calvingRecords, setCalvingRecords] = useLocalStorage('calvingRecords_v2', []);
  const [feedingRecords, setFeedingRecords] = useLocalStorage('feedingRecords_v2', []);
  const [medicationRecords, setMedicationRecords] = useLocalStorage('medicationRecords_v2', []);
  const [weightRecords, setWeightRecords] = useLocalStorage('weightRecords', []);
  const [feedInventory, setFeedInventory] = useLocalStorage('feedInventory_v2', []);
  const [medInventory, setMedInventory] = useLocalStorage('medInventory_v2', []);

  const s = {
    app: {maxWidth:'1400px',margin:'0 auto',background:'white',minHeight:'100vh',boxShadow:'0 0 40px rgba(0,0,0,0.1)'},
    header: {background:'linear-gradient(135deg,#5d4e37,#7a6a4f)',color:'white',padding:'2rem'},
    tabs: {display:'flex',background:'#f8f5f0',borderBottom:'2px solid #e0d5c0',flexWrap:'wrap',overflowX:'auto'},
    tab: (active) => ({flex:'0 0 auto',minWidth:'55px',padding:'0.75rem 0.5rem',background:active?'white':'none',border:'none',borderBottom:active?'3px solid #7a6a4f':'3px solid transparent',cursor:'pointer',fontWeight:600,color:'#5d4e37',fontSize:'0.7rem'}),
    content: {padding:'2rem'},
    btn: {padding:'0.75rem 1.5rem',background:'#7a6a4f',color:'white',border:'none',borderRadius:'8px',cursor:'pointer',fontWeight:600,display:'inline-flex',alignItems:'center',gap:'0.5rem'},
    modal: {position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.5)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000,padding:'1rem'},
    modalBox: {background:'white',borderRadius:'12px',padding:'2rem',width:'90%',maxWidth:'700px',maxHeight:'90vh',overflow:'auto'},
    input: {width:'100%',padding:'0.75rem',border:'2px solid #e0d5c0',borderRadius:'6px',fontFamily:'inherit'},
    label: {display:'block',marginBottom:'0.5rem',fontWeight:600,color:'#5d4e37',fontSize:'0.9rem'},
    table: {width:'100%',borderCollapse:'collapse',background:'white',border:'1px solid #e0d5c0',borderRadius:'8px',overflow:'hidden'},
    th: {padding:'1rem',textAlign:'left',background:'#f8f5f0',borderBottom:'2px solid #e0d5c0',fontWeight:600,fontSize:'0.9rem'},
    td: {padding:'1rem',borderBottom:'1px solid #f0ebe2',fontSize:'0.9rem'},
    empty: {textAlign:'center',padding:'4rem 2rem',color:'#8a7a5f'}
  };

  const activeCattle = cattle.filter(c => c.status === 'active');
  const soldCattle = cattle.filter(c => c.status === 'sold');
  const deadCattle = cattle.filter(c => c.status === 'dead');
  const pregnantCattle = cattle.filter(c => c.status === 'active' && c.pregnancyStatus === 'Pregnant' && c.expectedCalvingDate);

  return (
    <div style={s.app}>
      <div style={s.header}>
        <h1 style={{fontSize:'2rem',marginBottom:'0.5rem'}}>üêÑ Cattle Manager Pro</h1>
        <p>Complete herd management with cost tracking</p>
      </div>
      <div style={s.tabs}>
        {[
          {id:'dashboard',label:'üìä Dash'},
          {id:'cattle',label:'üêÑ Cattle'},
          {id:'weights',label:'‚öñÔ∏è Weights'},
          {id:'pens',label:'üìç Pens'},
          {id:'purchases',label:'üõí Buy'},
          {id:'feeding',label:'üåæ Feed'},
          {id:'meds',label:'üíâ Meds'},
          {id:'inventory',label:'üì¶ Inventory'},
          {id:'calving',label:'üë∂ Calving'},
          {id:'sales',label:'üí∞ Sales'},
          {id:'deaths',label:'‚ö∞Ô∏è Deaths'},
          {id:'reports',label:'üìà Reports'}
        ].map(t => (
          <button key={t.id} style={s.tab(tab===t.id)} onClick={()=>setTab(t.id)}>
            {t.label}
          </button>
        ))}
      </div>
      <div style={s.content}>
        {tab==='dashboard' && <DashboardTab activeCattle={activeCattle} pregnantCattle={pregnantCattle} calvingRecords={calvingRecords} weightRecords={weightRecords} s={s}/>}
        {tab==='cattle' && <CattleTab cattle={activeCattle} pens={pens} weightRecords={weightRecords} s={s}/>}
        {tab==='weights' && <WeightsTab weightRecords={weightRecords} setWeightRecords={setWeightRecords} cattle={activeCattle} pens={pens} s={s}/>}
        {tab==='pens' && <PensTab pens={pens} setPens={setPens} cattle={activeCattle} s={s}/>}
        {tab==='purchases' && <PurchasesTab cattle={cattle} setCattle={setCattle} weightRecords={weightRecords} setWeightRecords={setWeightRecords} pens={pens} s={s}/>}
        {tab==='feeding' && <FeedingTab feedingRecords={feedingRecords} setFeedingRecords={setFeedingRecords} feedInventory={feedInventory} setFeedInventory={setFeedInventory} pens={pens} cattle={activeCattle} s={s}/>}
        {tab==='meds' && <MedsTab medicationRecords={medicationRecords} setMedicationRecords={setMedicationRecords} medInventory={medInventory} setMedInventory={setMedInventory} cattle={activeCattle} pens={pens} s={s}/>}
        {tab==='inventory' && <InventoryTab feedInventory={feedInventory} setFeedInventory={setFeedInventory} medInventory={medInventory} setMedInventory={setMedInventory} s={s}/>}
        {tab==='calving' && <CalvingTab cattle={cattle} setCattle={setCattle} calvingRecords={calvingRecords} setCalvingRecords={setCalvingRecords} weightRecords={weightRecords} setWeightRecords={setWeightRecords} pens={pens} s={s}/>}
        {tab==='sales' && <SalesTab cattle={cattle} setCattle={setCattle} soldCattle={soldCattle} s={s}/>}
        {tab==='deaths' && <DeathsTab cattle={cattle} setCattle={setCattle} deadCattle={deadCattle} s={s}/>}
        {tab==='reports' && <ReportsTab cattle={cattle} activeCattle={activeCattle} pregnantCattle={pregnantCattle} feedingRecords={feedingRecords} medicationRecords={medicationRecords} weightRecords={weightRecords} feedInventory={feedInventory} medInventory={medInventory} pens={pens} s={s}/>}
      </div>
    </div>
  );
};

const DashboardTab = ({activeCattle, pregnantCattle, calvingRecords, weightRecords, s}) => {
  const today = new Date();
  const next30Days = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
  const calvingNext30 = pregnantCattle.filter(c => {
    const calvingDate = new Date(c.expectedCalvingDate);
    return calvingDate >= today && calvingDate <= next30Days;
  });

  return (
    <div>
      <h2 style={{marginBottom:'2rem'}}>Dashboard</h2>
      <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(160px,1fr))',gap:'1.5rem',marginBottom:'2rem'}}>
        {[
          {icon:'üêÑ',value:activeCattle.length,label:'Active'},
          {icon:'ü§∞',value:pregnantCattle.length,label:'Pregnant'},
          {icon:'‚è∞',value:calvingNext30.length,label:'Due Soon'},
          {icon:'üë∂',value:calvingRecords.length,label:'Calves'},
          {icon:'‚öñÔ∏è',value:weightRecords.length,label:'Weights'}
        ].map((item,i)=>(
          <div key={i} style={{background:'white',border:'2px solid #e0d5c0',borderRadius:'12px',padding:'1.5rem',textAlign:'center'}}>
            <div style={{fontSize:'2.5rem'}}>{item.icon}</div>
            <div style={{fontSize:'2.5rem',fontWeight:700,color:'#5d4e37'}}>{item.value}</div>
            <div style={{fontSize:'0.85rem',color:'#8a7a5f'}}>{item.label}</div>
          </div>
        ))}
      </div>
      {calvingNext30.length > 0 && (
        <div style={{background:'white',border:'2px solid #ff9800',borderRadius:'12px',padding:'1.5rem'}}>
          <h3 style={{marginBottom:'1rem',color:'#ff6f00',fontSize:'1.1rem'}}>‚ö†Ô∏è Calving Expected (Next 30 Days)</h3>
          <div style={{overflowX:'auto'}}>
          <table style={s.table}>
            <thead><tr><th style={s.th}>Tag</th><th style={s.th}>Expected</th><th style={s.th}>Days</th></tr></thead>
            <tbody>
              {calvingNext30.sort((a,b) => new Date(a.expectedCalvingDate) - new Date(b.expectedCalvingDate)).slice(0,5).map(c => {
                const daysUntil = Math.ceil((new Date(c.expectedCalvingDate) - today) / (1000 * 60 * 60 * 24));
                return (
                  <tr key={c.id}>
                    <td style={s.td}><strong>{c.id}</strong></td>
                    <td style={s.td}>{c.expectedCalvingDate}</td>
                    <td style={s.td}><span style={{padding:'0.25rem 0.5rem',background:daysUntil<=7?'#f8d7da':'#fff3cd',borderRadius:'4px',fontWeight:600,fontSize:'0.85rem'}}>{daysUntil}d</span></td>
                  </tr>
                );
              })}
            </tbody>
          </table>
          </div>
        </div>
      )}
    </div>
  );
};

const CattleTab = ({cattle, pens, weightRecords, s}) => {
  const getLatestWeight = (animalId) => {
    const animalWeights = weightRecords.filter(w => w.animalId === animalId).sort((a,b) => new Date(b.date) - new Date(a.date));
    return animalWeights[0]?.weight || null;
  };

  return (
    <div>
      <h2 style={{marginBottom:'2rem'}}>Active Cattle ({cattle.length})</h2>
      {cattle.length===0 ? (
        <div style={s.empty}><div style={{fontSize:'3rem'}}>üêÑ</div><p>No cattle. Add via Purchases tab.</p></div>
      ) : (
        <div style={{overflowX:'auto'}}>
        <table style={s.table}>
          <thead><tr><th style={s.th}>Tag</th><th style={s.th}>Age</th><th style={s.th}>Latest Wt</th><th style={s.th}>Pen</th><th style={s.th}>Status</th></tr></thead>
          <tbody>
            {cattle.map(a=>{
              const latestWt = getLatestWeight(a.id);
              return (
                <tr key={a.id}>
                  <td style={s.td}><strong>{a.id}</strong></td>
                  <td style={s.td}>{calculateAge(a.birthDate)}</td>
                  <td style={s.td}>{latestWt ? `${latestWt} lbs` : `${a.weight} lbs`}</td>
                  <td style={s.td}>{pens.find(p=>p.id===a.penId)?.name||'‚Äî'}</td>
                  <td style={s.td}>{a.pregnancyStatus==='Pregnant'?'ü§∞':a.pregnancyStatus||'‚Äî'}</td>
                </tr>
              );
            })}
          </tbody>
        </table>
        </div>
      )}
    </div>
  );
};

const WeightsTab = ({weightRecords, setWeightRecords, cattle, pens, s}) => {
  const [show, setShow] = useState(false);
  const [selectionMode, setSelectionMode] = useState('individual');
  const [f, setF] = useState({date:new Date().toISOString().split('T')[0],animalIds:[],penId:'',weight:'',notes:''});

  const reset = () => {
    setF({date:new Date().toISOString().split('T')[0],animalIds:[],penId:'',weight:'',notes:''});
    setShow(false);
  };

  const submit = (e) => {
    e.preventDefault();
    let animalIdsToRecord = [];
    if(selectionMode === 'pen') {
      animalIdsToRecord = cattle.filter(c => c.penId === f.penId).map(c => c.id);
    } else {
      animalIdsToRecord = f.animalIds;
    }
    animalIdsToRecord.forEach(animalId => {
      setWeightRecords(prev => [...prev, {
        id: `WT${Date.now()}_${animalId}_${Math.random()}`,
        animalId,
        date: f.date,
        weight: parseFloat(f.weight),
        notes: f.notes,
        createdAt: new Date().toISOString()
      }]);
    });
    alert(`Weight recorded for ${animalIdsToRecord.length} animal(s)!`);
    reset();
  };

  const getADG = (animalId) => {
    const weights = weightRecords.filter(w => w.animalId === animalId).sort((a,b) => new Date(a.date) - new Date(b.date));
    if(weights.length < 2) return null;
    const first = weights[0];
    const last = weights[weights.length - 1];
    const weightGain = last.weight - first.weight;
    const days = Math.floor((new Date(last.date) - new Date(first.date)) / (1000*60*60*24));
    return days > 0 ? (weightGain / days) : 0;
  };

  return (
    <div>
      <div style={{display:'flex',justifyContent:'space-between',marginBottom:'2rem'}}>
        <h2>Weight Records ({weightRecords.length})</h2>
        <button style={s.btn} onClick={()=>setShow(true)}>‚ûï Record Weight</button>
      </div>

      {show && (
        <div style={s.modal} onClick={reset}>
          <div style={s.modalBox} onClick={e=>e.stopPropagation()}>
            <h3 style={{marginBottom:'1.5rem'}}>Record Weight</h3>
            <form onSubmit={submit}>
              <div style={{marginBottom:'1rem'}}>
                <label style={s.label}>Date *</label>
                <input style={s.input} type="date" value={f.date} onChange={e=>setF({...f,date:e.target.value})} required/>
              </div>
              <div style={{marginBottom:'1rem'}}>
                <label style={s.label}>Selection Mode *</label>
                <div style={{display:'flex',gap:'0.5rem',flexWrap:'wrap'}}>
                  <button type="button" onClick={()=>setSelectionMode('individual')} style={{...s.btn,fontSize:'0.85rem',background:selectionMode==='individual'?'#7a6a4f':'#e0d5c0',color:selectionMode==='individual'?'white':'#5d4e37'}}>Individual</button>
                  <button type="button" onClick={()=>setSelectionMode('multiple')} style={{...s.btn,fontSize:'0.85rem',background:selectionMode==='multiple'?'#7a6a4f':'#e0d5c0',color:selectionMode==='multiple'?'white':'#5d4e37'}}>Multiple</button>
                  <button type="button" onClick={()=>setSelectionMode('pen')} style={{...s.btn,fontSize:'0.85rem',background:selectionMode==='pen'?'#7a6a4f':'#e0d5c0',color:selectionMode==='pen'?'white':'#5d4e37'}}>Entire Pen</button>
                </div>
              </div>
              {selectionMode === 'pen' ? (
                <div style={{marginBottom:'1rem'}}>
                  <label style={s.label}>Pen *</label>
                  <select style={s.input} value={f.penId} onChange={e=>setF({...f,penId:e.target.value})} required>
                    <option value="">Select Pen</option>
                    {pens.map(p=><option key={p.id} value={p.id}>{p.name} ({cattle.filter(c=>c.penId===p.id).length} head)</option>)}
                  </select>
                </div>
              ) : (
                <div style={{marginBottom:'1rem'}}>
                  <label style={s.label}>Animal(s) *</label>
                  <select style={s.input} multiple={selectionMode==='multiple'} value={selectionMode==='individual'?f.animalIds[0]||'':f.animalIds} onChange={e=>setF({...f,animalIds:selectionMode==='individual'?[e.target.value]:Array.from(e.target.selectedOptions, opt=>opt.value)})} required>
                    <option value="">Select Animal</option>
                    {cattle.map(c=><option key={c.id} value={c.id}>{c.id}</option>)}
                  </select>
                  {selectionMode==='multiple' && <small>Hold Ctrl/Cmd for multiple</small>}
                </div>
              )}
              <div style={{marginBottom:'1rem'}}>
                <label style={s.label}>Weight (lbs) *</label>
                <input style={s.input} type="number" step="0.1" value={f.weight} onChange={e=>setF({...f,weight:e.target.value})} required/>
              </div>
              <div style={{marginBottom:'1rem'}}>
                <label style={s.label}>Notes</label>
                <textarea style={{...s.input,fontFamily:'inherit'}} value={f.notes} onChange={e=>setF({...f,notes:e.target.value})} rows="2"/>
              </div>
              <div style={{display:'flex',gap:'1rem',justifyContent:'flex-end'}}>
                <button type="button" onClick={reset} style={{...s.btn,background:'#e0d5c0',color:'#5d4e37'}}>Cancel</button>
                <button type="submit" style={s.btn}>üíæ Save</button>
              </div>
            </form>
          </div>
        </div>
      )}

      {weightRecords.length===0 ? (
        <div style={s.empty}><div style={{fontSize:'3rem'}}>‚öñÔ∏è</div><p>No weight records</p></div>
      ) : (
        <div style={{overflowX:'auto'}}>
        <table style={s.table}>
          <thead><tr><th style={s.th}>Date</th><th style={s.th}>Animal</th><th style={s.th}>Weight</th><th style={s.th}>ADG</th><th style={s.th}>Notes</th></tr></thead>
          <tbody>
            {[...weightRecords].reverse().map(r=>(
              <tr key={r.id}>
                <td style={s.td}>{r.date}</td>
                <td style={s.td}><strong>{r.animalId}</strong></td>
                <td style={s.td}>{r.weight} lbs</td>
                <td style={s.td}>{getADG(r.animalId) ? `${getADG(r.animalId).toFixed(2)} lbs/day` : '‚Äî'}</td>
                <td style={s.td}>{r.notes||'‚Äî'}</td>
              </tr>
            ))}
          </tbody>
        </table>
        </div>
      )}
    </div>
  );
};

const PensTab = ({pens, setPens, cattle, s}) => {
  const [show, setShow] = useState(false);
  const [f, setF] = useState({name:''});

  const reset = () => {
    setF({name:''});
    setShow(false);
  };

  const submit = (e) => {
    e.preventDefault();
    setPens([...pens, {...f, id:`P${Date.now()}`}]);
    reset();
  };

  return (
    <div>
      <div style={{display:'flex',justifyContent:'space-between',marginBottom:'2rem'}}>
        <h2>Pens ({pens.length})</h2>
        <button style={s.btn} onClick={()=>setShow(true)}>‚ûï Add Pen</button>
      </div>

      {show && (
        <div style={s.modal} onClick={reset}>
          <div style={{...s.modalBox,maxWidth:'400px'}} onClick={e=>e.stopPropagation()}>
            <h3>Add Pen</h3>
            <form onSubmit={submit}>
              <div style={{marginBottom:'1rem'}}>
                <label style={s.label}>Pen Name *</label>
                <input style={s.input} value={f.name} onChange={e=>setF({...f,name:e.target.value})} required/>
              </div>
              <div style={{display:'flex',gap:'1rem',justifyContent:'flex-end'}}>
                <button type="button" onClick={reset} style={{...s.btn,background:'#e0d5c0',color:'#5d4e37'}}>Cancel</button>
                <button type="submit" style={s.btn}>üíæ Save</button>
              </div>
            </form>
          </div>
        </div>
      )}

      {pens.length===0 ? (
        <div style={s.empty}><div style={{fontSize:'3rem'}}>üìç</div><p>No pens. Create one to organize your cattle.</p></div>
      ) : (
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(220px,1fr))',gap:'1.5rem'}}>
          {pens.map(p=>(
            <div key={p.id} style={{background:'white',border:'2px solid #e0d5c0',borderRadius:'12px',padding:'1.5rem'}}>
              <h3 style={{marginBottom:'1rem'}}>{p.name}</h3>
              <div style={{borderTop:'1px solid #f0ebe2',paddingTop:'1rem'}}>
                <strong>{cattle.filter(c=>c.penId===p.id).length}</strong> animals
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

const PurchasesTab = ({cattle, setCattle, weightRecords, setWeightRecords, pens, s}) => {
  const [show, setShow] = useState(false);
  const [f, setF] = useState({earTag:'',purchaseDate:new Date().toISOString().split('T')[0],seller:'',price:'',weight:'',sex:'Female',breed:'',birthDate:'',penId:'',pregnancyStatus:'Open',expectedCalvingDate:'',notes:''});

  const reset = () => {
    setF({earTag:'',purchaseDate:new Date().toISOString().split('T')[0],seller:'',price:'',weight:'',sex:'Female',breed:'',birthDate:'',penId:'',pregnancyStatus:'Open',expectedCalvingDate:'',notes:''});
    setShow(false);
  };

  const submit = (e) => {
    e.preventDefault();
    
    const newAnimal = {
      id: f.earTag,
      sex: f.sex,
      weight: f.weight,
      breed: f.breed,
      birthDate: f.birthDate,
      penId: f.penId,
      healthNotes: f.notes,
      status: 'active',
      pregnancyStatus: f.pregnancyStatus,
      expectedCalvingDate: f.pregnancyStatus === 'Pregnant' ? f.expectedCalvingDate : '',
      purchaseDate: f.purchaseDate,
      purchasePrice: f.price,
      seller: f.seller,
      createdAt: new Date().toISOString()
    };
    setCattle([...cattle, newAnimal]);
    
    // Create initial weight record
    if(f.weight) {
      setWeightRecords([...weightRecords, {
        id: `WT${Date.now()}`,
        animalId: f.earTag,
        date: f.purchaseDate,
        weight: parseFloat(f.weight),
        notes: 'Purchase weight',
        createdAt: new Date().toISOString()
      }]);
    }
    
    alert(`${f.earTag} added!`);
    reset();
  };

  const purchases = cattle.filter(c => c.purchaseDate);

  return (
    <div>
      <div style={{display:'flex',justifyContent:'space-between',marginBottom:'2rem'}}>
        <h2>Purchase Cattle</h2>
        <button style={s.btn} onClick={()=>setShow(true)}>‚ûï Record Purchase</button>
      </div>

      {show && (
        <div style={s.modal} onClick={reset}>
          <div style={s.modalBox} onClick={e=>e.stopPropagation()}>
            <h3 style={{marginBottom:'1.5rem'}}>Record Purchase</h3>
            <form onSubmit={submit}>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem',marginBottom:'1rem'}}>
                <div>
                  <label style={s.label}>Ear Tag *</label>
                  <input style={s.input} value={f.earTag} onChange={e=>setF({...f,earTag:e.target.value})} required/>
                </div>
                <div>
                  <label style={s.label}>Purchase Date *</label>
                  <input style={s.input} type="date" value={f.purchaseDate} onChange={e=>setF({...f,purchaseDate:e.target.value})} required/>
                </div>
              </div>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem',marginBottom:'1rem'}}>
                <div>
                  <label style={s.label}>Sex *</label>
                  <select style={s.input} value={f.sex} onChange={e=>setF({...f,sex:e.target.value})} required>
                    <option>Female</option><option>Male</option><option>Steer</option>
                  </select>
                </div>
                <div>
                  <label style={s.label}>Weight (lbs) *</label>
                  <input style={s.input} type="number" value={f.weight} onChange={e=>setF({...f,weight:e.target.value})} required/>
                </div>
              </div>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem',marginBottom:'1rem'}}>
                <div>
                  <label style={s.label}>Birth Date</label>
                  <input style={s.input} type="date" value={f.birthDate} onChange={e=>setF({...f,birthDate:e.target.value})}/>
                </div>
                <div>
                  <label style={s.label}>Breed</label>
                  <input style={s.input} value={f.breed} onChange={e=>setF({...f,breed:e.target.value})}/>
                </div>
              </div>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem',marginBottom:'1rem'}}>
                <div>
                  <label style={s.label}>Seller</label>
                  <input style={s.input} value={f.seller} onChange={e=>setF({...f,seller:e.target.value})}/>
                </div>
                <div>
                  <label style={s.label}>Price ($)</label>
                  <input style={s.input} type="number" step="0.01" value={f.price} onChange={e=>setF({...f,price:e.target.value})}/>
                </div>
              </div>
              <div style={{marginBottom:'1rem'}}>
                <label style={s.label}>Pen</label>
                <select style={s.input} value={f.penId} onChange={e=>setF({...f,penId:e.target.value})}>
                  <option value="">No Pen</option>
                  {pens.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}
                </select>
              </div>
              <div style={{display:'grid',gridTemplateColumns:f.pregnancyStatus==='Pregnant'?'1fr 1fr':'1fr',gap:'1rem',marginBottom:'1rem'}}>
                <div>
                  <label style={s.label}>Status</label>
                  <select style={s.input} value={f.pregnancyStatus} onChange={e=>setF({...f,pregnancyStatus:e.target.value})}>
                    <option>Open</option><option>Pregnant</option><option>Bull</option><option>Steer</option>
                  </select>
                </div>
                {f.pregnancyStatus === 'Pregnant' && (
                  <div>
                    <label style={s.label}>Expected Calving</label>
                    <input style={s.input} type="date" value={f.expectedCalvingDate} onChange={e=>setF({...f,expectedCalvingDate:e.target.value})}/>
                  </div>
                )}
              </div>
              <div style={{marginBottom:'1rem'}}>
                <label style={s.label}>Notes</label>
                <textarea style={{...s.input,fontFamily:'inherit'}} value={f.notes} onChange={e=>setF({...f,notes:e.target.value})} rows="2"/>
              </div>
              <div style={{padding:'1rem',background:'#e8f5e9',border:'1px solid #4caf50',borderRadius:'6px',marginBottom:'1rem',fontSize:'0.85rem'}}>
                ‚úì Creates active animal record<br/>
                ‚úì Records initial weight
              </div>
              <div style={{display:'flex',gap:'1rem',justifyContent:'flex-end'}}>
                <button type="button" onClick={reset} style={{...s.btn,background:'#e0d5c0',color:'#5d4e37'}}>Cancel</button>
                <button type="submit" style={s.btn}>üíæ Purchase</button>
              </div>
            </form>
          </div>
        </div>
      )}

      {purchases.length > 0 && (
        <div style={{marginTop:'2rem'}}>
          <h3 style={{marginBottom:'1rem'}}>Recent Purchases</h3>
          <div style={{overflowX:'auto'}}>
          <table style={s.table}>
            <thead><tr><th style={s.th}>Date</th><th style={s.th}>Tag</th><th style={s.th}>Sex</th><th style={s.th}>Weight</th><th style={s.th}>Price</th><th style={s.th}>Status</th></tr></thead>
            <tbody>
              {[...purchases].reverse().slice(0,10).map(p=>(
                <tr key={p.id}>
                  <td style={s.td}>{p.purchaseDate}</td>
                  <td style={s.td}><strong>{p.id}</strong></td>
                  <td style={s.td}>{p.sex}</td>
                  <td style={s.td}>{p.weight} lbs</td>
                  <td style={s.td}>{p.purchasePrice?`$${parseFloat(p.purchasePrice).toFixed(2)}`:'‚Äî'}</td>
                  <td style={s.td}><span style={{padding:'0.25rem 0.5rem',background:p.status==='active'?'#e8f5e9':p.status==='sold'?'#fff3cd':'#f8d7da',borderRadius:'4px',fontSize:'0.85rem'}}>{p.status}</span></td>
                </tr>
              ))}
            </tbody>
          </table>
          </div>
        </div>
      )}
    </div>
  );
};

const CalvingTab = ({cattle, setCattle, calvingRecords, setCalvingRecords, weightRecords, setWeightRecords, pens, s}) => {
  const [show, setShow] = useState(false);
  const [f, setF] = useState({damId:'',calfId:'',calvingDate:new Date().toISOString().split('T')[0],birthWeight:'',calfSex:'Female',calvingEase:'1',assistanceNeeded:'None',calfPenId:'',notes:''});

  const pregnantCattle = cattle.filter(c => c.status === 'active' && c.pregnancyStatus === 'Pregnant');

  const reset = () => {
    setF({damId:'',calfId:'',calvingDate:new Date().toISOString().split('T')[0],birthWeight:'',calfSex:'Female',calvingEase:'1',assistanceNeeded:'None',calfPenId:'',notes:''});
    setShow(false);
  };

  const submit = (e) => {
    e.preventDefault();
    
    // Create calving record
    setCalvingRecords([...calvingRecords, {
      id: `CAL${Date.now()}`,
      ...f,
      createdAt: new Date().toISOString()
    }]);

    // Create new calf animal
    const dam = cattle.find(c => c.id === f.damId);
    const newCalf = {
      id: f.calfId,
      sex: f.calfSex,
      weight: f.birthWeight,
      breed: dam?.breed || '',
      birthDate: f.calvingDate,
      penId: f.calfPenId,
      healthNotes: `Born to ${f.damId}. ${f.notes}`,
      damId: f.damId,
      status: 'active',
      pregnancyStatus: f.calfSex === 'Female' ? 'Open' : (f.calfSex === 'Steer' ? 'Steer' : 'Bull'),
      createdAt: new Date().toISOString()
    };
    setCattle([...cattle, newCalf]);

    // Create birth weight record
    setWeightRecords([...weightRecords, {
      id: `WT${Date.now()}`,
      animalId: f.calfId,
      date: f.calvingDate,
      weight: parseFloat(f.birthWeight),
      notes: 'Birth weight',
      createdAt: new Date().toISOString()
    }]);

    // Update dam to Open
    setCattle(cattle.map(c => {
      if(c.id === f.damId) {
        return {...c, pregnancyStatus: 'Open', expectedCalvingDate: ''};
      }
      return c;
    }));

    alert(`Calf ${f.calfId} created! Dam ${f.damId} marked as Open.`);
    reset();
  };

  return (
    <div>
      <div style={{display:'flex',justifyContent:'space-between',marginBottom:'2rem'}}>
        <h2>Calving Records ({calvingRecords.length})</h2>
        <button style={s.btn} onClick={()=>setShow(true)}>‚ûï Record Calving</button>
      </div>

      {show && (
        <div style={s.modal} onClick={reset}>
          <div style={s.modalBox} onClick={e=>e.stopPropagation()}>
            <h3 style={{marginBottom:'1.5rem'}}>Record Calving</h3>
            <form onSubmit={submit}>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem',marginBottom:'1rem'}}>
                <div>
                  <label style={s.label}>Dam (Mother) *</label>
                  <select style={s.input} value={f.damId} onChange={e=>setF({...f,damId:e.target.value})} required>
                    <option value="">Select Dam</option>
                    {pregnantCattle.map(c=><option key={c.id} value={c.id}>{c.id} - {c.breed||'Unknown'}</option>)}
                  </select>
                </div>
                <div>
                  <label style={s.label}>Calving Date *</label>
                  <input style={s.input} type="date" value={f.calvingDate} onChange={e=>setF({...f,calvingDate:e.target.value})} required/>
                </div>
              </div>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'1rem',marginBottom:'1rem'}}>
                <div>
                  <label style={s.label}>Calf Ear Tag *</label>
                  <input style={s.input} value={f.calfId} onChange={e=>setF({...f,calfId:e.target.value})} required placeholder="e.g., C2026-001"/>
                </div>
                <div>
                  <label style={s.label}>Sex *</label>
                  <select style={s.input} value={f.calfSex} onChange={e=>setF({...f,calfSex:e.target.value})} required>
                    <option>Female</option><option>Male</option>
                  </select>
                </div>
                <div>
                  <label style={s.label}>Birth Wt (lbs) *</label>
                  <input style={s.input} type="number" value={f.birthWeight} onChange={e=>setF({...f,birthWeight:e.target.value})} required/>
                </div>
              </div>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr 1fr',gap:'1rem',marginBottom:'1rem'}}>
                <div>
                  <label style={s.label}>Calving Ease *</label>
                  <select style={s.input} value={f.calvingEase} onChange={e=>setF({...f,calvingEase:e.target.value})}>
                    <option value="1">1 - Easy</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5 - Difficult</option>
                  </select>
                </div>
                <div>
                  <label style={s.label}>Assistance</label>
                  <select style={s.input} value={f.assistanceNeeded} onChange={e=>setF({...f,assistanceNeeded:e.target.value})}>
                    <option>None</option><option>Minimal</option><option>Moderate</option><option>Veterinary</option>
                  </select>
                </div>
                <div>
                  <label style={s.label}>Calf Pen</label>
                  <select style={s.input} value={f.calfPenId} onChange={e=>setF({...f,calfPenId:e.target.value})}>
                    <option value="">No Pen</option>
                    {pens.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}
                  </select>
                </div>
              </div>
              <div style={{marginBottom:'1rem'}}>
                <label style={s.label}>Notes</label>
                <textarea style={{...s.input,fontFamily:'inherit'}} value={f.notes} onChange={e=>setF({...f,notes:e.target.value})} rows="2"/>
              </div>
              <div style={{padding:'1rem',background:'#e8f5e9',border:'1px solid #4caf50',borderRadius:'6px',marginBottom:'1rem',fontSize:'0.85rem'}}>
                ‚úì Creates calf animal record<br/>
                ‚úì Records birth weight<br/>
                ‚úì Marks dam as "Open"
              </div>
              <div style={{display:'flex',gap:'1rem',justifyContent:'flex-end'}}>
                <button type="button" onClick={reset} style={{...s.btn,background:'#e0d5c0',color:'#5d4e37'}}>Cancel</button>
                <button type="submit" style={s.btn}>üíæ Record Calving</button>
              </div>
            </form>
          </div>
        </div>
      )}

      {calvingRecords.length===0 ? (
        <div style={s.empty}><div style={{fontSize:'3rem'}}>üë∂</div><p>No calving records</p></div>
      ) : (
        <div style={{overflowX:'auto'}}>
        <table style={s.table}>
          <thead><tr><th style={s.th}>Date</th><th style={s.th}>Dam</th><th style={s.th}>Calf</th><th style={s.th}>Sex</th><th style={s.th}>Birth Wt</th><th style={s.th}>Ease</th><th style={s.th}>Assistance</th></tr></thead>
          <tbody>
            {[...calvingRecords].reverse().map(r=>(
              <tr key={r.id}>
                <td style={s.td}>{r.calvingDate}</td>
                <td style={s.td}>{r.damId}</td>
                <td style={s.td}><strong>{r.calfId}</strong></td>
                <td style={s.td}>{r.calfSex}</td>
                <td style={s.td}>{r.birthWeight} lbs</td>
                <td style={s.td}>{r.calvingEase}</td>
                <td style={s.td}>{r.assistanceNeeded}</td>
              </tr>
            ))}
          </tbody>
        </table>
        </div>
      )}
    </div>
  );
};

const SalesTab = ({cattle, setCattle, soldCattle, s}) => {
  const [show, setShow] = useState(false);
  const [f, setF] = useState({animalId:'',saleDate:new Date().toISOString().split('T')[0],buyer:'',price:'',saleWeight:'',notes:''});

  const activeCattle = cattle.filter(c => c.status === 'active');

  const reset = () => {
    setF({animalId:'',saleDate:new Date().toISOString().split('T')[0],buyer:'',price:'',saleWeight:'',notes:''});
    setShow(false);
  };

  const submit = (e) => {
    e.preventDefault();
    setCattle(cattle.map(c => {
      if(c.id === f.animalId) {
        return {...c, status:'sold', saleDate:f.saleDate, buyer:f.buyer, salePrice:f.price, saleWeight:f.saleWeight, saleNotes:f.notes};
      }
      return c;
    }));
    alert(`${f.animalId} marked as sold!`);
    reset();
  };

  return (
    <div>
      <div style={{display:'flex',justifyContent:'space-between',marginBottom:'2rem'}}>
        <h2>Sales ({soldCattle.length})</h2>
        <button style={s.btn} onClick={()=>setShow(true)}>‚ûï Record Sale</button>
      </div>

      {show && (
        <div style={s.modal} onClick={reset}>
          <div style={{...s.modalBox,maxWidth:'500px'}} onClick={e=>e.stopPropagation()}>
            <h3 style={{marginBottom:'1.5rem'}}>Record Sale</h3>
            <form onSubmit={submit}>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem',marginBottom:'1rem'}}>
                <div>
                  <label style={s.label}>Animal *</label>
                  <select style={s.input} value={f.animalId} onChange={e=>setF({...f,animalId:e.target.value})} required>
                    <option value="">Select Animal</option>
                    {activeCattle.map(c=><option key={c.id} value={c.id}>{c.id}</option>)}
                  </select>
                </div>
                <div>
                  <label style={s.label}>Sale Date *</label>
                  <input style={s.input} type="date" value={f.saleDate} onChange={e=>setF({...f,saleDate:e.target.value})} required/>
                </div>
              </div>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem',marginBottom:'1rem'}}>
                <div>
                  <label style={s.label}>Buyer</label>
                  <input style={s.input} value={f.buyer} onChange={e=>setF({...f,buyer:e.target.value})}/>
                </div>
                <div>
                  <label style={s.label}>Price ($)</label>
                  <input style={s.input} type="number" step="0.01" value={f.price} onChange={e=>setF({...f,price:e.target.value})}/>
                </div>
              </div>
              <div style={{marginBottom:'1rem'}}>
                <label style={s.label}>Sale Weight (lbs)</label>
                <input style={s.input} type="number" value={f.saleWeight} onChange={e=>setF({...f,saleWeight:e.target.value})}/>
              </div>
              <div style={{marginBottom:'1rem'}}>
                <label style={s.label}>Notes</label>
                <textarea style={{...s.input,fontFamily:'inherit'}} value={f.notes} onChange={e=>setF({...f,notes:e.target.value})} rows="2"/>
              </div>
              <div style={{padding:'1rem',background:'#fff3cd',border:'1px solid #ffc107',borderRadius:'6px',marginBottom:'1rem',fontSize:'0.85rem'}}>
                ‚ö†Ô∏è Marks animal as SOLD
              </div>
              <div style={{display:'flex',gap:'1rem',justifyContent:'flex-end'}}>
                <button type="button" onClick={reset} style={{...s.btn,background:'#e0d5c0',color:'#5d4e37'}}>Cancel</button>
                <button type="submit" style={s.btn}>üíæ Record Sale</button>
              </div>
            </form>
          </div>
        </div>
      )}

      {soldCattle.length===0 ? (
        <div style={s.empty}><div style={{fontSize:'3rem'}}>üí∞</div><p>No sales</p></div>
      ) : (
        <div style={{overflowX:'auto'}}>
        <table style={s.table}>
          <thead><tr><th style={s.th}>Date</th><th style={s.th}>Tag</th><th style={s.th}>Buyer</th><th style={s.th}>Weight</th><th style={s.th}>Price</th></tr></thead>
          <tbody>
            {[...soldCattle].reverse().map(a=>(
              <tr key={a.id}>
                <td style={s.td}>{a.saleDate}</td>
                <td style={s.td}><strong>{a.id}</strong></td>
                <td style={s.td}>{a.buyer||'‚Äî'}</td>
                <td style={s.td}>{a.saleWeight?`${a.saleWeight} lbs`:'‚Äî'}</td>
                <td style={s.td}>{a.salePrice?`$${parseFloat(a.salePrice).toFixed(2)}`:'‚Äî'}</td>
              </tr>
            ))}
          </tbody>
        </table>
        </div>
      )}
    </div>
  );
};

const DeathsTab = ({cattle, setCattle, deadCattle, s}) => {
  const [show, setShow] = useState(false);
  const [f, setF] = useState({animalId:'',deathDate:new Date().toISOString().split('T')[0],cause:'',notes:''});

  const activeCattle = cattle.filter(c => c.status === 'active');

  const reset = () => {
    setF({animalId:'',deathDate:new Date().toISOString().split('T')[0],cause:'',notes:''});
    setShow(false);
  };

  const submit = (e) => {
    e.preventDefault();
    setCattle(cattle.map(c => {
      if(c.id === f.animalId) {
        return {...c, status:'dead', deathDate:f.deathDate, deathCause:f.cause, deathNotes:f.notes};
      }
      return c;
    }));
    alert(`${f.animalId} marked as deceased`);
    reset();
  };

  return (
    <div>
      <div style={{display:'flex',justifyContent:'space-between',marginBottom:'2rem'}}>
        <h2>Deaths ({deadCattle.length})</h2>
        <button style={s.btn} onClick={()=>setShow(true)}>‚ûï Record Death</button>
      </div>

      {show && (
        <div style={s.modal} onClick={reset}>
          <div style={{...s.modalBox,maxWidth:'500px'}} onClick={e=>e.stopPropagation()}>
            <h3 style={{marginBottom:'1.5rem'}}>Record Death</h3>
            <form onSubmit={submit}>
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem',marginBottom:'1rem'}}>
                <div>
                  <label style={s.label}>Animal *</label>
                  <select style={s.input} value={f.animalId} onChange={e=>setF({...f,animalId:e.target.value})} required>
                    <option value="">Select Animal</option>
                    {activeCattle.map(c=><option key={c.id} value={c.id}>{c.id}</option>)}
                  </select>
                </div>
                <div>
                  <label style={s.label}>Death Date *</label>
                  <input style={s.input} type="date" value={f.deathDate} onChange={e=>setF({...f,deathDate:e.target.value})} required/>
                </div>
              </div>
              <div style={{marginBottom:'1rem'}}>
                <label style={s.label}>Cause</label>
                <input style={s.input} value={f.cause} onChange={e=>setF({...f,cause:e.target.value})} placeholder="e.g., Illness, Injury"/>
              </div>
              <div style={{marginBottom:'1rem'}}>
                <label style={s.label}>Notes</label>
                <textarea style={{...s.input,fontFamily:'inherit'}} value={f.notes} onChange={e=>setF({...f,notes:e.target.value})} rows="3"/>
              </div>
              <div style={{padding:'1rem',background:'#f8d7da',border:'1px solid #dc3545',borderRadius:'6px',marginBottom:'1rem',fontSize:'0.85rem',color:'#721c24'}}>
                ‚ö†Ô∏è Marks animal as DEAD
              </div>
              <div style={{display:'flex',gap:'1rem',justifyContent:'flex-end'}}>
                <button type="button" onClick={reset} style={{...s.btn,background:'#e0d5c0',color:'#5d4e37'}}>Cancel</button>
                <button type="submit" style={s.btn}>üíæ Record Death</button>
              </div>
            </form>
          </div>
        </div>
      )}

      {deadCattle.length===0 ? (
        <div style={s.empty}><div style={{fontSize:'3rem'}}>‚ö∞Ô∏è</div><p>No deaths</p></div>
      ) : (
        <div style={{overflowX:'auto'}}>
        <table style={s.table}>
          <thead><tr><th style={s.th}>Date</th><th style={s.th}>Tag</th><th style={s.th}>Breed</th><th style={s.th}>Cause</th><th style={s.th}>Notes</th></tr></thead>
          <tbody>
            {[...deadCattle].reverse().map(a=>(
              <tr key={a.id}>
                <td style={s.td}>{a.deathDate}</td>
                <td style={s.td}><strong>{a.id}</strong></td>
                <td style={s.td}>{a.breed||'‚Äî'}</td>
                <td style={s.td}>{a.deathCause||'‚Äî'}</td>
                <td style={s.td}>{a.deathNotes||'‚Äî'}</td>
              </tr>
            ))}
          </tbody>
        </table>
        </div>
      )}
    </div>
  );
};

const FeedingTab = ({feedingRecords, setFeedingRecords, feedInventory, setFeedInventory, pens, cattle, s}) => {
  const [show, setShow] = useState(false);
  const [selectionMode, setSelectionMode] = useState('pen');
  const [f, setF] = useState({date:new Date().toISOString().split('T')[0],feedType:'',amount:'',unit:'lbs',penIds:[],animalIds:[],notes:''});

  const reset = () => {
    setF({date:new Date().toISOString().split('T')[0],feedType:'',amount:'',unit:'lbs',penIds:[],animalIds:[],notes:''});
    setShow(false);
  };

  const submit = (e) => {
    e.preventDefault();
    setFeedInventory(feedInventory.map(item => {
      if(item.name === f.feedType) {
        return {...item, quantity: item.quantity - parseFloat(f.amount)};
      }
      return item;
    }));
    setFeedingRecords([...feedingRecords, {
      id: `FEED${Date.now()}`,
      ...f,
      selectionMode,
      createdAt: new Date().toISOString()
    }]);
    alert('Feeding recorded!');
    reset();
  };

  return (
    <div>
      <div style={{display:'flex',justifyContent:'space-between',marginBottom:'2rem'}}>
        <h2>Feeding Records ({feedingRecords.length})</h2>
        <button style={s.btn} onClick={()=>setShow(true)}>‚ûï Record</button>
      </div>

      {show && (
        <div style={s.modal} onClick={reset}>
          <div style={s.modalBox} onClick={e=>e.stopPropagation()}>
            <h3 style={{marginBottom:'1.5rem'}}>Record Feeding</h3>
            <form onSubmit={submit}>
              <div style={{marginBottom:'1rem'}}>
                <label style={s.label}>Date *</label>
                <input style={s.input} type="date" value={f.date} onChange={e=>setF({...f,date:e.target.value})} required/>
              </div>
              <div style={{marginBottom:'1rem'}}>
                <label style={s.label}>Feed To *</label>
                <div style={{display:'flex',gap:'0.5rem'}}>
                  <button type="button" onClick={()=>setSelectionMode('pen')} style={{...s.btn,fontSize:'0.85rem',background:selectionMode==='pen'?'#7a6a4f':'#e0d5c0',color:selectionMode==='pen'?'white':'#5d4e37'}}>Pen(s)</button>
                  <button type="button" onClick={()=>setSelectionMode('animals')} style={{...s.btn,fontSize:'0.85rem',background:selectionMode==='animals'?'#7a6a4f':'#e0d5c0',color:selectionMode==='animals'?'white':'#5d4e37'}}>Animal(s)</button>
                </div>
              </div>
              {selectionMode === 'pen' ? (
                <div style={{marginBottom:'1rem'}}>
                  <label style={s.label}>Pens *</label>
                  <select style={s.input} multiple value={f.penIds} onChange={e=>setF({...f,penIds:Array.from(e.target.selectedOptions, opt=>opt.value)})} required>
                    {pens.map(p=><option key={p.id} value={p.id}>{p.name} ({cattle.filter(c=>c.penId===p.id).length} head)</option>)}
                  </select>
                  <small>Hold Ctrl/Cmd for multiple</small>
                </div>
              ) : (
                <div style={{marginBottom:'1rem'}}>
                  <label style={s.label}>Animals *</label>
                  <select style={s.input} multiple value={f.animalIds} onChange={e=>setF({...f,animalIds:Array.from(e.target.selectedOptions, opt=>opt.value)})} required>
                    {cattle.map(c=><option key={c.id} value={c.id}>{c.id}</option>)}
                  </select>
                  <small>Hold Ctrl/Cmd for multiple</small>
                </div>
              )}
              <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem',marginBottom:'1rem'}}>
                <div>
                  <label style={s.label}>Feed Type *</label>
                  <select style={s.input} value={f.feedType} onChange={e=>setF({...f,feedType:e.target.value})} required>
                    <option value="">Select</option>
                    {feedInventory.filter(item=>item.quantity>0).map(item=><option key={item.id} value={item.name}>{item.name} ({item.quantity} {item.unit})</option>)}
                  </select>
                </div>
                <div>
                  <label style={s.label}>Amount *</label>
                  <input style={s.input} type="number" step="0.01" value={f.amount} onChange={e=>setF({...f,amount:e.target.value})} required/>
                </div>
              </div>
              <div style={{display:'flex',gap:'1rem',justifyContent:'flex-end'}}>
                <button type="button" onClick={reset} style={{...s.btn,background:'#e0d5c0',color:'#5d4e37'}}>Cancel</button>
                <button type="submit" style={s.btn}>üíæ Save</button>
              </div>
            </form>
          </div>
        </div>
      )}

      {feedingRecords.length===0 ? (
        <div style={s.empty}><div style={{fontSize:'3rem'}}>üåæ</div><p>No records</p></div>
      ) : (
        <div style={{overflowX:'auto'}}>
        <table style={s.table}>
          <thead><tr><th style={s.th}>Date</th><th style={s.th}>Feed</th><th style={s.th}>Amount</th><th style={s.th}>Fed To</th></tr></thead>
          <tbody>
            {[...feedingRecords].reverse().map(r=>(
              <tr key={r.id}>
                <td style={s.td}>{r.date}</td>
                <td style={s.td}>{r.feedType}</td>
                <td style={s.td}>{r.amount} {r.unit}</td>
                <td style={s.td}>{r.selectionMode==='pen' ? `${r.penIds.length} pen(s)` : `${r.animalIds.length} animal(s)`}</td>
              </tr>
            ))}
          </tbody>
        </table>
        </div>
      )}
    </div>
  );
};

const MedsTab = ({medicationRecords, setMedicationRecords, medInventory, setMedInventory, cattle, pens, s}) => {
  const [show, setShow] = useState(false);
  const [selectionMode, setSelectionMode] = useState('individual');
  const [f, setF] = useState({date:new Date().toISOString().split('T')[0],medication:'',dosage:'',dosageUnit:'ml',animalIds:[],penId:'',reason:'',notes:''});

  const reset = () => {
    setF({date:new Date().toISOString().split('T')[0],medication:'',dosage:'',dosageUnit:'ml',animalIds:[],penId:'',reason:'',notes:''});
    setShow(false);
  };

  const submit = (e) => {
    e.preventDefault();
    let animalIdsToRecord = [];
    if(selectionMode === 'pen') {
      animalIdsToRecord = cattle.filter(c => c.penId === f.penId).map(c => c.id);
    } else {
      animalIdsToRecord = f.animalIds;
    }
    const totalDosage = parseFloat(f.dosage) * animalIdsToRecord.length;
    setMedInventory(medInventory.map(item => {
      if(item.name === f.medication) {
        return {...item, quantity: item.quantity - totalDosage};
      }
      return item;
    }));
    animalIdsToRecord.forEach(animalId => {
      setMedicationRecords(prev => [...prev, {
        id: `MED${Date.now()}_${animalId}_${Math.random()}`,
        animalId,
        date: f.date,
        medication: f.medication,
        dosage: parseFloat(f.dosage),
        dosageUnit: f.dosageUnit,
        reason: f.reason,
        notes: f.notes,
        createdAt: new Date().toISOString()
      }]);
    });
    alert(`Medication recorded for ${animalIdsToRecord.length} animal(s)!`);
    reset();
  };

  return (
    <div>
      <div style={{display:'flex',justifyContent:'space-between',marginBottom:'2rem'}}>
        <h2>Medications ({medicationRecords.length})</h2>
        <button style={s.btn} onClick={()=>setShow(true)}>‚ûï Record</button>
      </div>

      {show && (
        <div style={s.modal} onClick={reset}>
          <div style={s.modalBox} onClick={e=>e.stopPropagation()}>
            <h3 style={{marginBottom:'1.5rem'}}>Record Medication</h3>
            <form onSubmit={submit}>
              <div style={{marginBottom:'1rem'}}>
                <label style={s.label}>Date *</label>
                <input style={s.input} type="date" value={f.date} onChange={e=>setF({...f,date:e.target.value})} required/>
              </div>
              <div style={{marginBottom:'1rem'}}>
                <label style={s.label}>Give To *</label>
                <div style={{display:'flex',gap:'0.5rem',flexWrap:'wrap'}}>
                  <button type="button" onClick={()=>setSelectionMode('individual')} style={{...s.btn,fontSize:'0.85rem',background:selectionMode==='individual'?'#7a6a4f':'#e0d5c0',color:selectionMode==='individual'?'white':'#5d4e37'}}>Individual</button>
                  <button type="button" onClick={()=>setSelectionMode('multiple')} style={{...s.btn,fontSize:'0.85rem',background:selectionMode==='multiple'?'#7a6a4f':'#e0d5c0',color:selectionMode==='multiple'?'white':'#5d4e37'}}>Multiple</button>
                  <button type="button" onClick={()=>setSelectionMode('pen')} style={{...s.btn,fontSize:'0.85rem',background:selectionMode==='pen'?'#7a6a4f':'#e0d5c0',color:selectionMode==='pen'?'white':'#5d4e37'}}>Pen</button>
                </div>
              </div>
              {selectionMode === 'pen' ? (
                <div style={{marginBottom:'1rem'}}>
                  <label style={s.label}>Pen *</label>
                  <select style={s.input} value={f.penId} onChange={e=>setF({...f,penId:e.target.value})} required>
                    <option value="">Select</option>
                    {pens.map(p=><option key={p.id} value={p.id}>{p.name} ({cattle.filter(c=>c.penId===p.id).length} head)</option>)}
                  </select>
                </div>
              ) : (
                <div style={{marginBottom:'1rem'}}>
                  <label style={s.label}>Animal(s) *</label>
                  <select style={s.input} multiple={selectionMode==='multiple'} value={selectionMode==='individual'?f.animalIds[0]||'':f.animalIds} onChange={e=>setF({...f,animalIds:selectionMode==='individual'?[e.target.value]:Array.from(e.target.selectedOptions, opt=>opt.value)})} required>
                    <option value="">Select</option>
                    {cattle.map(c=><option key={c.id} value={c.id}>{c.id}</option>)}
                  </select>
                  {selectionMode==='multiple' && <small>Hold Ctrl/Cmd for multiple</small>}
                </div>
              )}
              <div style={{display:'grid',gridTemplateColumns:'2fr 1fr',gap:'1rem',marginBottom:'1rem'}}>
                <div>
                  <label style={s.label}>Medication *</label>
                  <select style={s.input} value={f.medication} onChange={e=>setF({...f,medication:e.target.value})} required>
                    <option value="">Select</option>
                    {medInventory.filter(item=>item.quantity>0).map(item=><option key={item.id} value={item.name}>{item.name} ({item.quantity} {item.unit})</option>)}
                  </select>
                </div>
                <div>
                  <label style={s.label}>Dosage *</label>
                  <input style={s.input} type="number" step="0.1" value={f.dosage} onChange={e=>setF({...f,dosage:e.target.value})} required/>
                </div>
              </div>
              <div style={{marginBottom:'1rem'}}>
                <label style={s.label}>Reason</label>
                <input style={s.input} value={f.reason} onChange={e=>setF({...f,reason:e.target.value})} placeholder="e.g., Respiratory infection"/>
              </div>
              <div style={{display:'flex',gap:'1rem',justifyContent:'flex-end'}}>
                <button type="button" onClick={reset} style={{...s.btn,background:'#e0d5c0',color:'#5d4e37'}}>Cancel</button>
                <button type="submit" style={s.btn}>üíæ Save</button>
              </div>
            </form>
          </div>
        </div>
      )}

      {medicationRecords.length===0 ? (
        <div style={s.empty}><div style={{fontSize:'3rem'}}>üíâ</div><p>No records</p></div>
      ) : (
        <div style={{overflowX:'auto'}}>
        <table style={s.table}>
          <thead><tr><th style={s.th}>Date</th><th style={s.th}>Animal</th><th style={s.th}>Medication</th><th style={s.th}>Dosage</th><th style={s.th}>Reason</th></tr></thead>
          <tbody>
            {[...medicationRecords].reverse().map(r=>(
              <tr key={r.id}>
                <td style={s.td}>{r.date}</td>
                <td style={s.td}><strong>{r.animalId}</strong></td>
                <td style={s.td}>{r.medication}</td>
                <td style={s.td}>{r.dosage} {r.dosageUnit}</td>
                <td style={s.td}>{r.reason||'‚Äî'}</td>
              </tr>
            ))}
          </tbody>
        </table>
        </div>
      )}
    </div>
  );
};

const InventoryTab = ({feedInventory, setFeedInventory, medInventory, setMedInventory, s}) => {
  const [activeTab, setActiveTab] = useState('feed');
  const [show, setShow] = useState(false);
  const [f, setF] = useState({name:'',quantity:'',unit:'lbs',costPerUnit:'',notes:''});

  const reset = () => {
    setF({name:'',quantity:'',unit:'lbs',costPerUnit:'',notes:''});
    setShow(false);
  };

  const submit = (e) => {
    e.preventDefault();
    const newItem = {
      id: `INV${Date.now()}`,
      ...f,
      quantity: parseFloat(f.quantity),
      costPerUnit: parseFloat(f.costPerUnit) || 0,
      createdAt: new Date().toISOString()
    };
    if(activeTab === 'feed') {
      setFeedInventory([...feedInventory, newItem]);
    } else {
      setMedInventory([...medInventory, newItem]);
    }
    reset();
  };

  const currentInv = activeTab === 'feed' ? feedInventory : medInventory;
  const totalValue = currentInv.reduce((sum, item) => sum + (item.quantity * (item.costPerUnit || 0)), 0);

  return (
    <div>
      <h2 style={{marginBottom:'2rem'}}>Inventory</h2>
      <div style={{display:'flex',gap:'1rem',marginBottom:'2rem',flexWrap:'wrap'}}>
        <button onClick={()=>setActiveTab('feed')} style={{...s.btn,background:activeTab==='feed'?'#7a6a4f':'#e0d5c0',color:activeTab==='feed'?'white':'#5d4e37'}}>Feed</button>
        <button onClick={()=>setActiveTab('meds')} style={{...s.btn,background:activeTab==='meds'?'#7a6a4f':'#e0d5c0',color:activeTab==='meds'?'white':'#5d4e37'}}>Meds</button>
        <button style={s.btn} onClick={()=>setShow(true)}>‚ûï Add Item</button>
      </div>

      {show && (
        <div style={s.modal} onClick={reset}>
          <div style={s.modalBox} onClick={e=>e.stopPropagation()}>
            <h3>Add {activeTab==='feed'?'Feed':'Medication'}</h3>
            <form onSubmit={submit}>
              <div style={{marginBottom:'1rem'}}>
                <label style={s.label}>Name *</label>
                <input style={s.input} value={f.name} onChange={e=>setF({...f,name:e.target.value})} required/>
              </div>
              <div style={{display:'grid',gridTemplateColumns:'2fr 1fr',gap:'1rem',marginBottom:'1rem'}}>
                <div>
                  <label style={s.label}>Quantity *</label>
                  <input style={s.input} type="number" step="0.01" value={f.quantity} onChange={e=>setF({...f,quantity:e.target.value})} required/>
                </div>
                <div>
                  <label style={s.label}>Unit *</label>
                  <select style={s.input} value={f.unit} onChange={e=>setF({...f,unit:e.target.value})}>
                    {activeTab==='feed'?<><option>lbs</option><option>tons</option><option>bales</option></>:<><option>ml</option><option>cc</option><option>doses</option></>}
                  </select>
                </div>
              </div>
              <div style={{marginBottom:'1rem'}}>
                <label style={s.label}>Cost Per Unit ($)</label>
                <input style={s.input} type="number" step="0.01" value={f.costPerUnit} onChange={e=>setF({...f,costPerUnit:e.target.value})} placeholder="e.g., 0.25"/>
              </div>
              <div style={{display:'flex',gap:'1rem',justifyContent:'flex-end'}}>
                <button type="button" onClick={reset} style={{...s.btn,background:'#e0d5c0',color:'#5d4e37'}}>Cancel</button>
                <button type="submit" style={s.btn}>üíæ Save</button>
              </div>
            </form>
          </div>
        </div>
      )}

      <div style={{marginBottom:'1.5rem',padding:'1rem',background:'#f8f5f0',borderRadius:'8px'}}>
        <strong>Total {activeTab==='feed'?'Feed':'Medication'} Value: ${totalValue.toFixed(2)}</strong>
      </div>

      {currentInv.length===0 ? (
        <div style={s.empty}><p>No inventory</p></div>
      ) : (
        <div style={{overflowX:'auto'}}>
        <table style={s.table}>
          <thead><tr><th style={s.th}>Name</th><th style={s.th}>Quantity</th><th style={s.th}>Cost/Unit</th><th style={s.th}>Total Value</th></tr></thead>
          <tbody>
            {currentInv.map(item=>(
              <tr key={item.id}>
                <td style={s.td}><strong>{item.name}</strong></td>
                <td style={s.td}>{item.quantity.toFixed(2)} {item.unit}</td>
                <td style={s.td}>${(item.costPerUnit||0).toFixed(2)}</td>
                <td style={s.td}>${(item.quantity * (item.costPerUnit||0)).toFixed(2)}</td>
              </tr>
            ))}
          </tbody>
        </table>
        </div>
      )}
    </div>
  );
};

const ReportsTab = ({cattle, activeCattle, pregnantCattle, feedingRecords, medicationRecords, weightRecords, feedInventory, medInventory, pens, s}) => {
  const [dateRange, setDateRange] = useState({start:'',end:''});
  const [selectedPens, setSelectedPens] = useState([]);

  const downloadCSV = (data, filename) => {
    const csv = data.map(row=>row.join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
  };

  const exportCostOfGainReport = () => {
    const csvData = [['Animal ID','Purchase Cost','Feed Cost','Med Cost','Total Cost','Start Weight','Current Weight','Weight Gained','Days','ADG','Cost/Lb Gain']];
    activeCattle.forEach(animal => {
      const purchaseCost = parseFloat(animal.purchasePrice) || 0;
      const startDate = animal.purchaseDate ? new Date(animal.purchaseDate) : new Date(animal.createdAt);
      const daysOwned = Math.floor((new Date() - startDate) / (1000*60*60*24));
      const animalWeights = weightRecords.filter(w=>w.animalId===animal.id).sort((a,b)=>new Date(a.date)-new Date(b.date));
      const startWeight = animalWeights[0]?.weight || parseFloat(animal.weight) || 0;
      const currentWeight = animalWeights[animalWeights.length-1]?.weight || parseFloat(animal.weight) || 0;
      const weightGained = currentWeight - startWeight;
      let feedCost = 0;
      feedingRecords.forEach(feeding => {
        const feedItem = feedInventory.find(f=>f.name===feeding.feedType);
        const feedingCost = (parseFloat(feeding.amount) * (feedItem?.costPerUnit || 0));
        if(feeding.selectionMode==='pen' && feeding.penIds.includes(animal.penId)) {
          const animalsInPen = cattle.filter(c=>c.penId===animal.penId && c.status==='active').length;
          feedCost += feedingCost / (animalsInPen || 1);
        } else if(feeding.selectionMode==='animals' && feeding.animalIds.includes(animal.id)) {
          feedCost += feedingCost / (feeding.animalIds.length || 1);
        }
      });
      const medCost = medicationRecords.filter(m=>m.animalId===animal.id).reduce((sum, m) => {
        const medItem = medInventory.find(i=>i.name===m.medication);
        return sum + (m.dosage * (medItem?.costPerUnit || 0));
      }, 0);
      const totalCost = purchaseCost + feedCost + medCost;
      const costPerLb = weightGained > 0 ? (totalCost / weightGained) : 0;
      const adg = daysOwned > 0 ? (weightGained / daysOwned) : 0;
      csvData.push([animal.id,purchaseCost.toFixed(2),feedCost.toFixed(2),medCost.toFixed(2),totalCost.toFixed(2),startWeight.toFixed(1),currentWeight.toFixed(1),weightGained.toFixed(1),daysOwned,adg.toFixed(3),costPerLb.toFixed(2)]);
    });
    downloadCSV(csvData, `cost-of-gain-${new Date().toISOString().split('T')[0]}.csv`);
  };

  const filteredCalvings = pregnantCattle.filter(c => {
    if(!dateRange.start || !dateRange.end) return true;
    const calvingDate = new Date(c.expectedCalvingDate);
    return calvingDate >= new Date(dateRange.start) && calvingDate <= new Date(dateRange.end);
  });

  const exportCalvingReport = () => {
    const csvData = [['Tag','Breed','Age','Expected Date','Days Until']];
    const today = new Date();
    filteredCalvings.forEach(c => {
      const daysUntil = Math.ceil((new Date(c.expectedCalvingDate) - today) / (1000*60*60*24));
      csvData.push([c.id, c.breed||'', calculateAge(c.birthDate), c.expectedCalvingDate, daysUntil]);
    });
    downloadCSV(csvData, `expected-calving-${new Date().toISOString().split('T')[0]}.csv`);
  };

  const feedingByPen = feedingRecords.filter(r => {
    const inDateRange = (!dateRange.start || !dateRange.end) || (new Date(r.date) >= new Date(dateRange.start) && new Date(r.date) <= new Date(dateRange.end));
    const inSelectedPens = selectedPens.length === 0 || (r.selectionMode==='pen' && r.penIds.some(pid=>selectedPens.includes(pid)));
    return inDateRange && inSelectedPens;
  });

  const exportFeedingReport = () => {
    const csvData = [['Date','Feed','Amount','Unit','Fed To','Cost']];
    let totalCost = 0;
    feedingByPen.forEach(r => {
      const feedItem = feedInventory.find(f=>f.name===r.feedType);
      const cost = (parseFloat(r.amount) * (feedItem?.costPerUnit || 0));
      totalCost += cost;
      const fedTo = r.selectionMode==='pen' ? r.penIds.join(';') : `${r.animalIds.length} animals`;
      csvData.push([r.date, r.feedType, r.amount, r.unit, fedTo, cost.toFixed(2)]);
    });
    csvData.push(['','','','','TOTAL', totalCost.toFixed(2)]);
    downloadCSV(csvData, `feeding-report-${new Date().toISOString().split('T')[0]}.csv`);
  };

  const exportInventoryCostReport = () => {
    const csvData = [['Category','Item','Quantity','Unit','Cost/Unit','Total Value']];
    let feedTotal = 0;
    feedInventory.forEach(item => {
      const value = item.quantity * (item.costPerUnit || 0);
      feedTotal += value;
      csvData.push(['Feed', item.name, item.quantity, item.unit, (item.costPerUnit||0).toFixed(2), value.toFixed(2)]);
    });
    let medTotal = 0;
    medInventory.forEach(item => {
      const value = item.quantity * (item.costPerUnit || 0);
      medTotal += value;
      csvData.push(['Med', item.name, item.quantity, item.unit, (item.costPerUnit||0).toFixed(2), value.toFixed(2)]);
    });
    csvData.push(['','','','','Feed Total:', feedTotal.toFixed(2)]);
    csvData.push(['','','','','Med Total:', medTotal.toFixed(2)]);
    csvData.push(['','','','','GRAND TOTAL:', (feedTotal + medTotal).toFixed(2)]);
    downloadCSV(csvData, `inventory-cost-${new Date().toISOString().split('T')[0]}.csv`);
  };

  return (
    <div>
      <h2 style={{marginBottom:'2rem'}}>Reports</h2>
      <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(280px,1fr))',gap:'1.5rem'}}>
        <div style={{background:'white',border:'2px solid #e0d5c0',borderRadius:'12px',padding:'1.5rem'}}>
          <h3 style={{marginBottom:'1rem',fontSize:'1.1rem'}}>üíµ Cost of Gain</h3>
          <p style={{fontSize:'0.85rem',marginBottom:'1rem',color:'#5d4e37'}}>Purchase + Feed + Med costs per animal with weight gain & ADG</p>
          <p style={{fontSize:'0.85rem',marginBottom:'1rem'}}>{activeCattle.length} animals</p>
          <button onClick={exportCostOfGainReport} disabled={activeCattle.length===0} style={{...s.btn,fontSize:'0.85rem',opacity:activeCattle.length>0?1:0.5}}>‚¨áÔ∏è Download</button>
        </div>
        <div style={{background:'white',border:'2px solid #e0d5c0',borderRadius:'12px',padding:'1.5rem'}}>
          <h3 style={{marginBottom:'1rem',fontSize:'1.1rem'}}>üìÖ Expected Calving</h3>
          <div style={{marginBottom:'1rem'}}>
            <label style={{...s.label,fontSize:'0.85rem'}}>Date Range</label>
            <input style={{...s.input,marginBottom:'0.5rem',fontSize:'0.85rem'}} type="date" value={dateRange.start} onChange={e=>setDateRange({...dateRange,start:e.target.value})}/>
            <input style={{...s.input,fontSize:'0.85rem'}} type="date" value={dateRange.end} onChange={e=>setDateRange({...dateRange,end:e.target.value})}/>
          </div>
          <p style={{fontSize:'0.85rem',marginBottom:'1rem'}}>{filteredCalvings.length} in range</p>
          <button onClick={exportCalvingReport} disabled={filteredCalvings.length===0} style={{...s.btn,fontSize:'0.85rem',opacity:filteredCalvings.length>0?1:0.5}}>‚¨áÔ∏è Download</button>
        </div>
        <div style={{background:'white',border:'2px solid #e0d5c0',borderRadius:'12px',padding:'1.5rem'}}>
          <h3 style={{marginBottom:'1rem',fontSize:'1.1rem'}}>üåæ Feeding Report</h3>
          <div style={{marginBottom:'1rem'}}>
            <label style={{...s.label,fontSize:'0.85rem'}}>Pens</label>
            <select style={{...s.input,fontSize:'0.85rem'}} multiple value={selectedPens} onChange={e=>setSelectedPens(Array.from(e.target.selectedOptions, opt=>opt.value))}>
              {pens.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}
            </select>
          </div>
          <p style={{fontSize:'0.85rem',marginBottom:'1rem'}}>{feedingByPen.length} records</p>
          <button onClick={exportFeedingReport} disabled={feedingByPen.length===0} style={{...s.btn,fontSize:'0.85rem',opacity:feedingByPen.length>0?1:0.5}}>‚¨áÔ∏è Download</button>
        </div>
        <div style={{background:'white',border:'2px solid #e0d5c0',borderRadius:'12px',padding:'1.5rem'}}>
          <h3 style={{marginBottom:'1rem',fontSize:'1.1rem'}}>üì¶ Inventory Value</h3>
          <p style={{fontSize:'0.85rem',marginBottom:'1rem',color:'#5d4e37'}}>Total value of feed & medication inventory</p>
          <p style={{fontSize:'0.85rem',marginBottom:'1rem'}}>{feedInventory.length + medInventory.length} items</p>
          <button onClick={exportInventoryCostReport} style={{...s.btn,fontSize:'0.85rem'}}>‚¨áÔ∏è Download</button>
        </div>
      </div>
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
